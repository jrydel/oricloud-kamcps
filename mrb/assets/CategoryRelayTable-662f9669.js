import{f as $,d as U,_ as H}from"./dateTime-aa0fff04.js";import{A as t,i as P,u as z,e as G,a as J,f as E}from"./useDataProvider-3479f118.js";import{d as D,c as d,o as u,a as c,u as l,t as g,b as v,e as K,x as Q,r as X,g as B,w as Z,F as L,f as M,l as W,a5 as tt,q as et,h as st}from"./index-4a37b7ad.js";import{a as at}from"./CompetitionView-83eee9e6.js";const Y=s=>nt[s],nt={[t.Ok]:"OK",[t.Mispunch]:"DISK",[t.Disqualified]:"DISK",[t.DidNotFinish]:"DNF",[t.Running]:"...",[t.NotStarted]:"-",[t.OverMaxTime]:"DISK",[t.DidNotStart]:"DNS",[t.NotCompeting]:"MS"},lt={class:"grid gap-2 px-3 py-1.5"},ot={key:0,class:"tabular-nums"},rt={key:1,class:"tabular-nums"},ut={key:2},it={key:3,class:"text-right tabular-nums"},ct={key:4,class:"text-right tabular-nums"},dt={key:5,class:"text-right"},mt={class:"text-right tabular-nums"},gt=D({__name:"CategoryRelayTableRowTeam",props:{data:null},setup(s){const e=s,R=d(()=>e.data.latestTotalResult.status===t.Ok?$(e.data.latestTotalResult.timeSeconds):""),S=d(()=>e.data.latestTotalResult.status===t.Ok?`+ ${$(e.data.latestTotalResult.loss)}`:""),k=y=>y.replace(/\s/g,""),f=d(()=>k(e.data.name));return(y,p)=>(u(),c("div",lt,[s.data.status===l(t).Ok&&s.data.latestTotalResult.status===l(t).Ok?(u(),c("span",ot,g(s.data.latestTotalResult.rank)+".",1)):s.data.latestTotalResult.status===l(t).Ok?(u(),c("span",rt,"["+g(s.data.latestTotalResult.rank)+".]",1)):(u(),c("span",ut)),v("span",null,g(l(f))+" - "+g(s.data.club),1),s.data.status===l(t).Ok?(u(),c("span",it,g(l(R)),1)):s.data.status===l(t).Running&&l(R)?(u(),c("span",ct,"["+g(l(R))+"]",1)):(u(),c("span",dt,g(l(Y)(s.data.status)),1)),v("span",mt,g(l(S)),1)]))}}),ft=D({__name:"SlotVirtualizer",props:{isVisible:{type:Boolean}},setup(s){return(e,R)=>s.isVisible?K(e.$slots,"default",{key:0}):K(e.$slots,"placeholder",{key:1})}}),ht={class:"grid gap-2 px-3 py-1.5"},Rt=v("span",null,null,-1),Tt={key:0,class:"text-right tabular-nums"},yt={key:1,class:"text-right tabular-nums"},pt={key:2,class:"text-right tabular-nums"},_t={key:3,class:"text-right"},vt={class:"text-right tabular-nums"},St=D({__name:"CategoryRelayTableRowAthlete",props:{data:null},setup(s){const e=s,R=Q(P,X(!1)),{now:S,timeFormatter:k}=z(),f=d(()=>e.data.legResult.status===t.Ok?$(e.data.legResult.timeSeconds):""),y=d(()=>e.data.totalResult.status===t.Ok?`+ ${$(e.data.totalResult.loss)}`:""),p=d(()=>G(e.data.legResult)?e.data.startTime?e.data.startTime<S.value:e.data.status===t.Running:!1),x=d(()=>{if(!e.data.startTime||!p.value)return"";const _=U(S.value,e.data.startTime);return $(_)}),T=d(()=>e.data.status===t.NotStarted),C=d(()=>!e.data.startTime||!T.value?"":k.format(e.data.startTime));return(_,N)=>(u(),c("div",ht,[Rt,v("span",null,g(s.data.surname)+" "+g(s.data.firstName),1),B(ft,{"is-visible":l(R)},{default:Z(()=>[s.data.legResult.status===l(t).Ok?(u(),c("span",Tt,g(l(f))+" ["+g(s.data.legResult.rank)+".]",1)):l(p)?(u(),c("span",yt,"["+g(l(x))+"]",1)):l(T)?(u(),c("span",pt,g(l(C)),1)):(u(),c("span",_t,g(l(Y)(s.data.status)),1))]),_:1},8,["is-visible"]),v("span",vt,g(l(y)),1)]))}}),kt=v("span",null,null,-1),xt=v("span",null,".",-1),bt=[kt,xt],Ct=D({__name:"CategoryRelayTableRow",props:{data:null,isEven:{type:Boolean},legCount:null},setup(s){const e=s,{now5s:R}=z(),S=d(()=>e.legCount+1),k=5*60,f=d(()=>e.data.updatedAt?U(R.value,e.data.updatedAt)<k:!1),y=d(()=>f.value?"bg-highlight":e.isEven?"bg-even":"bg-white"),p=d(()=>f.value?"text-white":"text-black"),x=d(()=>{const T=e.legCount-e.data.athletes.length;return T>0?T:0});return(T,C)=>(u(),c("div",{class:tt([[`grid-rows-${l(S)}`,l(y),l(p)],"grid rounded-lg"])},[B(gt,{class:"table-row-grid text-table-large",data:e.data},null,8,["data"]),(u(!0),c(L,null,M(s.data.athletes,_=>(u(),W(St,{class:"table-row-grid text-table-small",key:_.id,data:_},null,8,["data"]))),128)),(u(!0),c(L,null,M(l(x),_=>(u(),c("div",{key:s.data.id+"-"+_,class:"table-row-grid text-table-small grid gap-2 px-3 py-1.5"},bt))),128))],2))}});function Nt({competition:s,category:e,fetchEnabled:R}){const{key:S,getRelayTeamsLoader:k}=J();if(!k)throw new Error(`Relay loader not available for provider ${S}`);const{relayTeams:f,status:y}=k({category:e,competition:s,fetchEnabled:R}),p=d(()=>{if(y.value!=="success"||!f.value||f.value.length===0)return 0;const a=f.value.map(i=>i.athletes.length);return Math.max(...a)}),x=[t.NotStarted,t.Running,t.Ok,t.DidNotStart,t.OverMaxTime,t.Mispunch,t.Disqualified,t.DidNotFinish,t.NotCompeting],T=d(()=>y.value!=="success"||!f.value?[]:f.value.flatMap(a=>{if(a.athletes.length===0)return[];let n=0,i=0;const o=[...a.athletes].sort((r,h)=>r.leg-h.leg);o.length!==p.value&&(i=x.length-1);const m=o.map((r,h,I)=>{var F;const b=x.findIndex(O=>O===r.status);if(b>i&&(i=b),r.status===t.Running||r.status===t.NotStarted){const O=h!==0&&r.startTime&&r.startTime.getTime()===((F=I[h-1].startTime)==null?void 0:F.getTime())?void 0:r.startTime;return{...r,startTime:O,legResult:{status:r.status},totalResult:{status:r.status}}}return n+=r.timeSeconds,{...r,legResult:{timeSeconds:r.timeSeconds,status:r.status},totalResult:{timeSeconds:n,status:x[i]}}});return[{...a,status:x[i],athletes:m}]})),C=a=>a.length===0?[]:a.reduce((n,i)=>{for(const o of i.athletes)n[o.leg-1].push(o);return n},Array.from({length:p.value},()=>[])),_=(a,n)=>{const i=[];for(const o of a){const m=o[n];E(m)&&i.push(m.timeSeconds)}return i.sort((o,m)=>o-m)},N=a=>a.length===0?[]:a.reduce((n,i,o)=>(n[o].legTimes=_(i,"legResult"),n[o].totalTimes=_(i,"totalResult"),n),Array.from({length:a.length},()=>({legTimes:[],totalTimes:[]}))),w=d(()=>{if(T.value.length===0)return[];const a=N(C(T.value)),n=a.map(o=>o.legTimes[0]),i=a.map(o=>o.totalTimes[0]);return T.value.map(o=>{let m=0;const r=o.athletes.map((h,I)=>{m===I&&h.status!==t.NotStarted&&h.status!==t.Running&&m++;const b=h.leg-1,F=E(h.legResult)?V(h.legResult,a[b].legTimes,n[b]):{...h.legResult},O=E(h.totalResult)?V(h.totalResult,a[b].totalTimes,i[b]):{...h.totalResult};return{...h,legResult:F,totalResult:O}});return{...o,athletes:r,legsDone:m,status:m!==p.value&&o.status===t.Ok?t.Running:o.status,latestTotalResult:r.length?r[m>0?m-1:0].totalResult:{status:t.NotStarted},updatedAt:m>0?r[m-1].updatedAt:void 0}})}),V=(a,n,i)=>{const o=a.timeSeconds,m=n.indexOf(o),r=$t(i,o);return{...a,rank:m+1,loss:r}},A=d(()=>w.value.length===0?[]:[...w.value].sort((a,n)=>a.status!==n.status?q[a.status]-q[n.status]:a.legsDone!==n.legsDone?n.legsDone-a.legsDone:a.latestTotalResult.status===t.Ok&&n.latestTotalResult.status===t.Ok&&a.latestTotalResult.timeSeconds!==n.latestTotalResult.timeSeconds?a.latestTotalResult.timeSeconds-n.latestTotalResult.timeSeconds:a.name.localeCompare(n.name))),j=d(()=>{const a=A.value.filter(n=>n.status!==t.NotStarted&&n.status!==t.Running);return{full:A.value.length,finished:a.length,unfinished:A.value.length-a.length}});return{status:y,relayTeams:A,teamCounts:j,legCount:p}}const Ot=[t.Ok,t.Running,t.NotStarted,t.OverMaxTime,t.NotCompeting,t.DidNotStart,t.DidNotFinish,t.Mispunch,t.Disqualified],q=Ot.reduce((s,e,R)=>(s[e]=R,s),{});function $t(s,e){return e-s}const Dt={class:"w-full text-table-large font-bold bg-white"},wt={key:0,class:"bg-gray-300 h-100"},At=v("span",null,"Loading data",-1),Ft=[At],Bt=D({__name:"CategoryRelayTable",props:{competition:null,category:null},setup(s){const e=s,{scrollItemRef:R,stickyRef:S,contentRef:k,isActive:f}=at(e.category.name),{relayTeams:y,teamCounts:p,status:x,legCount:T}=Nt({competition:e.competition,category:e.category,fetchEnabled:f});return et(P,f),(C,_)=>(u(),c("div",{ref_key:"scrollItemRef",ref:R},[v("div",{class:"sticky top-0",ref_key:"stickyRef",ref:S},[B(H,{class:"p-3",category:e.category,"athletes-count":l(p)},null,8,["category","athletes-count"])],512),v("div",{ref_key:"contentRef",ref:k},[v("div",Dt,[(u(!0),c(L,null,M(l(y),(N,w)=>(u(),W(Ct,{key:N.id,"is-even":w%2===0,data:N,"leg-count":l(T)},null,8,["is-even","data","leg-count"]))),128))])],512),l(x)!=="success"?(u(),c("div",wt,Ft)):st("",!0)],512))}});export{Bt as default};
